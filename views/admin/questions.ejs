<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Questions - AI Recruiting Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; background: #1e3a5f; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .question-card { border-left: 4px solid #0d6efd; }
    .question-card.required { border-left-color: #dc3545; }
    .category-badge { font-size: 0.75rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'questions' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-chat-square-text text-primary me-2"></i>Interview Questions</h2>
          <div>
            <div class="btn-group me-2">
              <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" data-bs-tooltip="tooltip" title="Import questions from file">
                <i class="bi bi-upload"></i> Import
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="excel"><i class="bi bi-file-earmark-excel me-2"></i>Import from Excel</a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="csv"><i class="bi bi-filetype-csv me-2"></i>Import from CSV</a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importModal" data-import-type="word"><i class="bi bi-file-earmark-word me-2"></i>Import from Word</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="downloadExcelTemplate"><i class="bi bi-file-earmark-excel me-2"></i>Download Excel Template</a></li>
                <li><a class="dropdown-item" href="#" id="downloadTemplate"><i class="bi bi-filetype-csv me-2"></i>Download CSV Template</a></li>
              </ul>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal" data-bs-tooltip="tooltip" title="Add a new question">
              <i class="bi bi-plus-lg"></i> Add Question
            </button>
          </div>
        </div>

        <% if (jobRoles && jobRoles.length > 0) { %>
          <% jobRoles.forEach(role => { %>
          <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-briefcase me-2"></i><%= role.title %></h5>
              <a href="/RecruitingAI/admin/job-roles/<%= role.id %>?token=<%= token %>" class="btn btn-sm btn-outline-primary">Manage</a>
            </div>
            <div class="card-body">
              <% if (role.categories && role.categories.length > 0) { %>
                <% role.categories.forEach(category => { %>
                <div class="mb-4">
                  <h6 class="text-uppercase text-muted mb-3">
                    <span class="badge bg-secondary category-badge"><%= category.name %></span>
                    <small class="ms-2">(<%= category.questions.length %> questions)</small>
                  </h6>
                  <% category.questions.forEach((question, idx) => { %>
                  <div class="card question-card mb-2 <%= question.isRequired ? 'required' : '' %>">
                    <div class="card-body py-2">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <div class="d-flex align-items-center mb-1">
                            <span class="badge bg-light text-dark me-2"><%= idx + 1 %></span>
                            <% if (question.isRequired) { %>
                            <span class="badge bg-danger me-2">Required</span>
                            <% } %>
                            <small class="text-muted"><%= question.timeAllocation %> min</small>
                          </div>
                          <p class="mb-1"><%= question.text %></p>
                          <% if (question.followUps && question.followUps.length > 0) { %>
                          <small class="text-muted">
                            <i class="bi bi-arrow-return-right"></i> Follow-ups: <%= question.followUps.join('; ') %>
                          </small>
                          <% } %>
                        </div>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-secondary" data-bs-toggle="tooltip" title="Edit">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button class="btn btn-outline-danger" data-bs-toggle="tooltip" title="Delete">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% }) %>
                </div>
                <% }) %>
              <% } else { %>
              <p class="text-muted text-center py-4">No question categories yet.</p>
              <% } %>
            </div>
          </div>
          <% }) %>
        <% } else { %>
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="bi bi-chat-square-text text-muted" style="font-size: 3rem;"></i>
            <h5 class="mt-3">No Questions Yet</h5>
            <p class="text-muted">Create a job role first, then add questions to it.</p>
            <a href="/RecruitingAI/admin/job-roles?token=<%= token %>" class="btn btn-primary">
              <i class="bi bi-briefcase"></i> Go to Job Roles
            </a>
          </div>
        </div>
        <% } %>
      </main>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-upload me-2"></i><span id="importModalTitle">Import Questions</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="importForm" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Target Job Role</label>
              <select class="form-select" name="jobRoleId" id="importJobRole" required>
                <option value="">Select a job role...</option>
                <% if (jobRoles) { %>
                  <% jobRoles.forEach(role => { %>
                  <option value="<%= role.id %>"><%= role.title %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select" name="categoryId" id="importCategory" required>
                <option value="">Select job role first...</option>
              </select>
              <small class="text-muted">Or create a new category:</small>
              <input type="text" class="form-control mt-1" name="newCategory" id="newCategory" placeholder="New category name (optional)">
            </div>

            <div class="mb-3">
              <label class="form-label">Upload File</label>
              <input type="file" class="form-control" name="file" id="importFile" required>
              <div class="form-text" id="fileHelp">
                <span id="excelHelp">Accepted: .xlsx, .xls files. Columns: Question, Followups (semicolon-separated), Time_Minutes, Required (yes/no), Evaluation_Criteria</span>
                <span id="csvHelp" style="display:none;">Accepted: .csv files. Columns: question, followups (semicolon-separated), time_minutes, required (yes/no), evaluation_criteria</span>
                <span id="wordHelp" style="display:none;">Accepted: .docx files. Each paragraph starting with a number or bullet will be treated as a question.</span>
              </div>
            </div>

            <!-- CSV Preview -->
            <div id="previewSection" style="display:none;">
              <label class="form-label">Preview</label>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-bordered" id="previewTable">
                  <thead class="table-light">
                    <tr id="previewHeader"></tr>
                  </thead>
                  <tbody id="previewBody"></tbody>
                </table>
              </div>
              <div class="mt-2">
                <span class="badge bg-info" id="previewCount">0 questions found</span>
              </div>
            </div>

            <!-- Word Preview -->
            <div id="wordPreviewSection" style="display:none;">
              <label class="form-label">Detected Questions</label>
              <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group list-group-flush" id="wordPreviewList"></ul>
              </div>
              <div class="mt-2">
                <span class="badge bg-info" id="wordPreviewCount">0 questions found</span>
              </div>
            </div>

            <div class="alert alert-info mt-3" id="importTips">
              <strong><i class="bi bi-lightbulb me-1"></i>Tips:</strong>
              <ul class="mb-0 mt-2" id="excelTips">
                <li>First row should be column headers</li>
                <li>Separate follow-up questions with semicolons or pipes (|)</li>
                <li>Use "yes" or "no" for required field</li>
                <li>Column names are flexible (e.g., "Question", "Text", "Q" all work)</li>
              </ul>
              <ul class="mb-0 mt-2" id="csvTips" style="display:none;">
                <li>First row should be headers</li>
                <li>Separate follow-up questions with semicolons</li>
                <li>Use "yes" or "no" for required field</li>
              </ul>
              <ul class="mb-0 mt-2" id="wordTips" style="display:none;">
                <li>Each numbered or bulleted item becomes a question</li>
                <li>Sub-bullets become follow-up questions</li>
                <li>Bold text at the start is treated as the category</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="importBtn" disabled>
              <i class="bi bi-upload"></i> Import Questions
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Question Modal -->
  <div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Add Question</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addQuestionForm">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Job Role</label>
                <select class="form-select" name="jobRoleId" id="addJobRole" required>
                  <option value="">Select a job role...</option>
                  <% if (jobRoles) { %>
                    <% jobRoles.forEach(role => { %>
                    <option value="<%= role.id %>"><%= role.title %></option>
                    <% }) %>
                  <% } %>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" name="categoryId" id="addCategory" required>
                  <option value="">Select job role first...</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Question Text</label>
              <textarea class="form-control" name="text" rows="3" required placeholder="Enter the interview question..."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Follow-up Questions</label>
              <textarea class="form-control" name="followUps" rows="2" placeholder="Enter follow-up questions, one per line..."></textarea>
              <small class="text-muted">One follow-up per line</small>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Time (minutes)</label>
                <input type="number" class="form-control" name="timeAllocation" value="5" min="1" max="30">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Required</label>
                <select class="form-select" name="isRequired">
                  <option value="false">No</option>
                  <option value="true">Yes</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Order</label>
                <input type="number" class="form-control" name="order" value="0" min="0">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Evaluation Criteria</label>
              <textarea class="form-control" name="evaluationCriteria" rows="2" placeholder="What to look for in a good answer..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Question</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Job role categories data
      const jobRoleCategories = {
        <% if (jobRoles) { %>
          <% jobRoles.forEach(role => { %>
          '<%= role.id %>': [
            <% if (role.categories) { %>
              <% role.categories.forEach(cat => { %>
              { id: '<%= cat.id %>', name: '<%= cat.name %>' },
              <% }) %>
            <% } %>
          ],
          <% }) %>
        <% } %>
      };

      // Import type handling
      let currentImportType = 'excel';

      document.querySelectorAll('[data-import-type]').forEach(el => {
        el.addEventListener('click', (e) => {
          currentImportType = e.target.closest('[data-import-type]').dataset.importType;
          updateImportUI();
        });
      });

      function updateImportUI() {
        const title = document.getElementById('importModalTitle');
        const fileInput = document.getElementById('importFile');
        const excelHelp = document.getElementById('excelHelp');
        const csvHelp = document.getElementById('csvHelp');
        const wordHelp = document.getElementById('wordHelp');
        const excelTips = document.getElementById('excelTips');
        const csvTips = document.getElementById('csvTips');
        const wordTips = document.getElementById('wordTips');

        // Hide all first
        excelHelp.style.display = 'none';
        csvHelp.style.display = 'none';
        wordHelp.style.display = 'none';
        excelTips.style.display = 'none';
        csvTips.style.display = 'none';
        wordTips.style.display = 'none';

        if (currentImportType === 'excel') {
          title.textContent = 'Import Questions from Excel';
          fileInput.accept = '.xlsx,.xls';
          excelHelp.style.display = '';
          excelTips.style.display = '';
        } else if (currentImportType === 'csv') {
          title.textContent = 'Import Questions from CSV';
          fileInput.accept = '.csv';
          csvHelp.style.display = '';
          csvTips.style.display = '';
        } else {
          title.textContent = 'Import Questions from Word';
          fileInput.accept = '.docx';
          wordHelp.style.display = '';
          wordTips.style.display = '';
        }

        // Reset file input and preview
        fileInput.value = '';
        document.getElementById('previewSection').style.display = 'none';
        document.getElementById('wordPreviewSection').style.display = 'none';
        document.getElementById('importBtn').disabled = true;
      }

      // Update category dropdown when job role changes
      function updateCategories(jobRoleSelect, categorySelect) {
        const roleId = jobRoleSelect.value;
        categorySelect.innerHTML = '<option value="">Select category...</option>';

        if (roleId && jobRoleCategories[roleId]) {
          jobRoleCategories[roleId].forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat.id;
            opt.textContent = cat.name;
            categorySelect.appendChild(opt);
          });
        }
      }

      document.getElementById('importJobRole').addEventListener('change', function() {
        updateCategories(this, document.getElementById('importCategory'));
      });

      document.getElementById('addJobRole')?.addEventListener('change', function() {
        updateCategories(this, document.getElementById('addCategory'));
      });

      // File preview
      document.getElementById('importFile').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (currentImportType === 'csv') {
          previewCSV(file);
        } else if (currentImportType === 'excel') {
          previewExcel(file);
        } else {
          previewWord(file);
        }
      });

      async function previewExcel(file) {
        const formData = new FormData();
        formData.append('file', file);

        // For Excel, we'll do a simple client-side preview using the first few rows
        // by sending to the same preview endpoint
        try {
          const response = await fetch('/admin/questions/preview-excel?token=<%= token %>', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();

          if (data.questions && data.questions.length > 0) {
            // Show in table format
            const headerRow = document.getElementById('previewHeader');
            headerRow.innerHTML = '<th>Question</th><th>Follow-ups</th><th>Time</th><th>Required</th>';

            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';

            for (let i = 0; i < Math.min(data.questions.length, 5); i++) {
              const q = data.questions[i];
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${q.text}</td>
                <td>${q.followUps?.join('; ') || '-'}</td>
                <td>${q.timeAllocation} min</td>
                <td>${q.isRequired ? 'Yes' : 'No'}</td>
              `;
              tbody.appendChild(row);
            }

            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('wordPreviewSection').style.display = 'none';
            document.getElementById('previewCount').textContent = `${data.questions.length} questions found`;
            document.getElementById('importBtn').disabled = false;
          } else {
            alert('No questions detected in the Excel file. Make sure you have a "Question" column.');
          }
        } catch (err) {
          console.error('Error previewing Excel file:', err);
          alert('Error parsing Excel file. Please check the format.');
        }
      }

      function previewCSV(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const lines = text.split('\n').filter(l => l.trim());
          if (lines.length < 2) {
            alert('CSV file must have headers and at least one data row');
            return;
          }

          const headers = parseCSVLine(lines[0]);
          const headerRow = document.getElementById('previewHeader');
          headerRow.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

          const tbody = document.getElementById('previewBody');
          tbody.innerHTML = '';

          for (let i = 1; i < Math.min(lines.length, 6); i++) {
            const values = parseCSVLine(lines[i]);
            const row = document.createElement('tr');
            row.innerHTML = values.map(v => `<td>${v}</td>`).join('');
            tbody.appendChild(row);
          }

          document.getElementById('previewSection').style.display = 'block';
          document.getElementById('wordPreviewSection').style.display = 'none';
          document.getElementById('previewCount').textContent = `${lines.length - 1} questions found`;
          document.getElementById('importBtn').disabled = false;
        };
        reader.readAsText(file);
      }

      async function previewWord(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch('/admin/questions/preview-word?token=<%= token %>', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();

          if (data.questions && data.questions.length > 0) {
            const list = document.getElementById('wordPreviewList');
            list.innerHTML = data.questions.map((q, i) => `
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span><strong>${i + 1}.</strong> ${q.text}</span>
                  ${q.followUps?.length ? `<small class="text-muted">${q.followUps.length} follow-ups</small>` : ''}
                </div>
              </li>
            `).join('');

            document.getElementById('wordPreviewSection').style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('wordPreviewCount').textContent = `${data.questions.length} questions found`;
            document.getElementById('importBtn').disabled = false;
          } else {
            alert('No questions detected in the Word document');
          }
        } catch (err) {
          console.error('Error previewing Word file:', err);
          alert('Error parsing Word file. Please check the format.');
        }
      }

      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }

      // Import form submission
      document.getElementById('importForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        formData.append('importType', currentImportType);

        try {
          const response = await fetch('/admin/questions/import?token=<%= token %>', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();

          if (data.success) {
            alert(`Successfully imported ${data.count} questions!`);
            location.reload();
          } else {
            alert('Import failed: ' + (data.error || 'Unknown error'));
          }
        } catch (err) {
          console.error('Import error:', err);
          alert('Import failed. Please try again.');
        }
      });

      // Download CSV template
      document.getElementById('downloadTemplate').addEventListener('click', function(e) {
        e.preventDefault();
        const template = 'question,followups,time_minutes,required,evaluation_criteria\n' +
          '"Tell me about yourself","What are your strengths?;What motivates you?",5,no,"Looking for clear communication and self-awareness"\n' +
          '"Describe a challenging project","How did you overcome obstacles?;What did you learn?",8,yes,"Problem-solving ability and growth mindset"';

        const blob = new Blob([template], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'questions_template.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      // Download Excel template
      document.getElementById('downloadExcelTemplate').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '/admin/questions/template.xlsx?token=<%= token %>';
      });

      // Add question form
      document.getElementById('addQuestionForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        data.followUps = data.followUps.split('\n').filter(f => f.trim());
        data.isRequired = data.isRequired === 'true';
        data.timeAllocation = parseInt(data.timeAllocation);
        data.order = parseInt(data.order);

        try {
          const response = await fetch('/admin/questions?token=<%= token %>', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await response.json();

          if (result.success) {
            location.reload();
          } else {
            alert('Failed to add question: ' + (result.error || 'Unknown error'));
          }
        } catch (err) {
          console.error('Error:', err);
          alert('Failed to add question');
        }
      });
    });
  </script>
</body>
</html>
