<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Settings - AI Recruiting Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script>window.APP_BASE_PATH = '<%= basePath %>';</script>
  <style>
    :root {
      --sidebar-bg: <%= branding?.primaryColor || '#0d9488' %>;
      --sidebar-hover: <%= branding?.secondaryColor || '#0f766e' %>;
      --primary-color: <%= branding?.primaryColor || '#0d9488' %>;
    }
    .sidebar {
      background: var(--sidebar-bg);
      height: calc(100vh - 56px);
      position: sticky;
      top: 56px;
      overflow-y: scroll !important;
      overflow-x: hidden;
    }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .sidebar::-webkit-scrollbar { width: 10px; display: block; }
    .sidebar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.4); border-radius: 5px; min-height: 40px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.6); }
    .sidebar { scrollbar-width: auto; scrollbar-color: rgba(255,255,255,0.4) rgba(0,0,0,0.2); }

    .account-section { background: #fff; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .account-section h5 { color: var(--primary-color); margin-bottom: 1rem; }
    .info-row { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #eee; }
    .info-row:last-child { border-bottom: none; }
    .info-label { font-weight: 500; color: #555; }
    .info-value { color: #333; }
    .payment-card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
    .payment-card.default { border-color: var(--primary-color); background: rgba(13, 148, 136, 0.05); }
    .card-info { display: flex; align-items: center; gap: 1rem; }
    .card-icon { font-size: 2rem; }
    .device-item { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
    .device-item.current { border-color: var(--primary-color); background: rgba(13, 148, 136, 0.05); }
    .notification-group { margin-bottom: 1.5rem; }
    .notification-group h6 { color: #333; margin-bottom: 0.75rem; font-weight: 600; }
    .notification-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
    .notification-switches { display: flex; gap: 1.5rem; }
    .nav-pills .nav-link { color: #555; }
    .nav-pills .nav-link.active { background: var(--primary-color); }
  </style>
</head>
<body>
  <%- include('_topnav', { token, basePath, branding, userRole, userName }) %>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'account', basePath, branding, userRole }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-shield-lock me-2" style="color: var(--primary-color);"></i>Account Settings</h2>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-pills mb-4" id="accountTabs">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="pill" href="#security"><i class="bi bi-shield-lock me-2"></i>Login & Security</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#payment"><i class="bi bi-credit-card me-2"></i>Payment Options</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#notifications"><i class="bi bi-bell me-2"></i>Notifications</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#devices"><i class="bi bi-laptop me-2"></i>Your Devices</a>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Login & Security Tab -->
          <div class="tab-pane fade show active" id="security">
            <div class="account-section">
              <h5><i class="bi bi-person me-2"></i>Personal Information</h5>
              <div class="info-row">
                <div>
                  <div class="info-label">Name</div>
                  <div class="info-value" id="displayName"><%= userName || 'Not set' %></div>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="showEditModal('name')" data-bs-toggle="tooltip" title="Edit your name">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              </div>
              <div class="info-row">
                <div>
                  <div class="info-label">Email</div>
                  <div class="info-value" id="displayEmail"><%= userEmail || 'Not set' %></div>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="showEditModal('email')" data-bs-toggle="tooltip" title="Change your email address">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              </div>
              <div class="info-row">
                <div>
                  <div class="info-label">Phone</div>
                  <div class="info-value" id="displayPhone"><%= user?.phone || 'Not set' %></div>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="showEditModal('phone')" data-bs-toggle="tooltip" title="Update your phone number">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              </div>
            </div>

            <div class="account-section">
              <h5><i class="bi bi-key me-2"></i>Password</h5>
              <div class="info-row">
                <div>
                  <div class="info-label">Password</div>
                  <div class="info-value text-muted">Last changed: Never</div>
                </div>
                <button class="btn btn-sm btn-outline-warning" onclick="showEditModal('password')" data-bs-toggle="tooltip" title="Change your password">
                  <i class="bi bi-key"></i> Change Password
                </button>
              </div>
            </div>

            <div class="account-section">
              <h5><i class="bi bi-shield-check me-2"></i>Two-Factor Authentication</h5>
              <div class="info-row">
                <div>
                  <div class="info-label">Status</div>
                  <div class="info-value"><span class="badge bg-secondary">Not Enabled</span></div>
                </div>
                <button class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Enable 2FA for extra security">
                  <i class="bi bi-shield-plus"></i> Enable 2FA
                </button>
              </div>
            </div>
          </div>

          <!-- Payment Options Tab -->
          <div class="tab-pane fade" id="payment">
            <div class="account-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Saved Payment Methods</h5>
                <button class="btn btn-sm btn-primary" onclick="showAddPaymentModal()" data-bs-toggle="tooltip" title="Add a new payment method">
                  <i class="bi bi-plus-lg"></i> Add Payment Method
                </button>
              </div>
              <div id="paymentMethodsList">
                <p class="text-muted text-center py-4">No payment methods saved yet.</p>
              </div>
            </div>

            <div class="account-section">
              <h5><i class="bi bi-receipt me-2"></i>Billing History</h5>
              <p class="text-muted">View your recent transactions and download invoices.</p>
              <a href="<%= basePath %>/admin/transactions?token=<%= token %>" class="btn btn-outline-primary" data-bs-toggle="tooltip" title="View all transactions">
                <i class="bi bi-list-ul me-2"></i>View Transaction History
              </a>
            </div>
          </div>

          <!-- Notifications Tab -->
          <div class="tab-pane fade" id="notifications">
            <div class="account-section">
              <h5><i class="bi bi-bell me-2"></i>Notification Preferences</h5>
              <p class="text-muted mb-4">Choose how you want to receive notifications.</p>

              <div class="notification-group">
                <h6><i class="bi bi-calendar-event me-2"></i>Interview Notifications</h6>
                <div class="notification-row">
                  <span>Interview Scheduled</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewScheduledEmail" data-key="interviewScheduledEmail" checked>
                      <label class="form-check-label" for="interviewScheduledEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewScheduledSms" data-key="interviewScheduledSms">
                      <label class="form-check-label" for="interviewScheduledSms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewScheduledPush" data-key="interviewScheduledPush" checked>
                      <label class="form-check-label" for="interviewScheduledPush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
                <div class="notification-row">
                  <span>Interview Reminders</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewReminderEmail" data-key="interviewReminderEmail" checked>
                      <label class="form-check-label" for="interviewReminderEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewReminderSms" data-key="interviewReminderSms" checked>
                      <label class="form-check-label" for="interviewReminderSms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewReminderPush" data-key="interviewReminderPush" checked>
                      <label class="form-check-label" for="interviewReminderPush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
                <div class="notification-row">
                  <span>Interview Completed</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewCompletedEmail" data-key="interviewCompletedEmail" checked>
                      <label class="form-check-label" for="interviewCompletedEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewCompletedSms" data-key="interviewCompletedSms">
                      <label class="form-check-label" for="interviewCompletedSms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="interviewCompletedPush" data-key="interviewCompletedPush" checked>
                      <label class="form-check-label" for="interviewCompletedPush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="notification-group">
                <h6><i class="bi bi-person-vcard me-2"></i>Candidate Notifications</h6>
                <div class="notification-row">
                  <span>New Candidate</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="newCandidateEmail" data-key="newCandidateEmail" checked>
                      <label class="form-check-label" for="newCandidateEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="newCandidateSms" data-key="newCandidateSms">
                      <label class="form-check-label" for="newCandidateSms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="newCandidatePush" data-key="newCandidatePush" checked>
                      <label class="form-check-label" for="newCandidatePush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
                <div class="notification-row">
                  <span>Candidate Results</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="candidateResultsEmail" data-key="candidateResultsEmail" checked>
                      <label class="form-check-label" for="candidateResultsEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="candidateResultsSms" data-key="candidateResultsSms">
                      <label class="form-check-label" for="candidateResultsSms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="candidateResultsPush" data-key="candidateResultsPush" checked>
                      <label class="form-check-label" for="candidateResultsPush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="notification-group">
                <h6><i class="bi bi-credit-card me-2"></i>Billing Notifications</h6>
                <div class="notification-row">
                  <span>Subscription Updates</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="subscriptionEmail" data-key="subscriptionEmail" checked>
                      <label class="form-check-label" for="subscriptionEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="subscriptionSms" data-key="subscriptionSms">
                      <label class="form-check-label" for="subscriptionSms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="subscriptionPush" data-key="subscriptionPush" checked>
                      <label class="form-check-label" for="subscriptionPush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
                <div class="notification-row">
                  <span>Payment Confirmations</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="paymentEmail" data-key="paymentEmail" checked>
                      <label class="form-check-label" for="paymentEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="paymentSms" data-key="paymentSms">
                      <label class="form-check-label" for="paymentSms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="paymentPush" data-key="paymentPush" checked>
                      <label class="form-check-label" for="paymentPush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="notification-group">
                <h6><i class="bi bi-shield-check me-2"></i>Security Notifications</h6>
                <div class="notification-row">
                  <span>Security Alerts</span>
                  <div class="notification-switches">
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="securityEmail" data-key="securityEmail" checked>
                      <label class="form-check-label" for="securityEmail"><i class="bi bi-envelope"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="securitySms" data-key="securitySms" checked>
                      <label class="form-check-label" for="securitySms"><i class="bi bi-phone"></i></label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input notification-toggle" type="checkbox" id="securityPush" data-key="securityPush" checked>
                      <label class="form-check-label" for="securityPush"><i class="bi bi-bell"></i></label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Devices Tab -->
          <div class="tab-pane fade" id="devices">
            <div class="account-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-laptop me-2"></i>Active Sessions</h5>
                <button class="btn btn-sm btn-outline-danger" onclick="signOutAllDevices()" data-bs-toggle="tooltip" title="Sign out of all devices except this one">
                  <i class="bi bi-box-arrow-right"></i> Sign Out All Other Devices
                </button>
              </div>
              <div id="devicesList">
                <div class="device-item current">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                      <i class="bi bi-laptop fs-3 text-primary"></i>
                      <div>
                        <div class="fw-bold">Current Device</div>
                        <small class="text-muted">This browser session</small>
                      </div>
                    </div>
                    <span class="badge bg-success">Active Now</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Edit Modals -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalTitle">Edit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="editModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Payment Method Modal -->
  <div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Add Payment Method</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Card Number</label>
            <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
          </div>
          <div class="mb-3">
            <label class="form-label">Cardholder Name</label>
            <input type="text" class="form-control" id="cardHolderName" placeholder="John Doe">
          </div>
          <div class="row">
            <div class="col-6">
              <label class="form-label">Expiry Date</label>
              <div class="d-flex gap-2">
                <select class="form-select" id="expiryMonth">
                  <% for(let i = 1; i <= 12; i++) { %>
                  <option value="<%= i %>"><%= String(i).padStart(2, '0') %></option>
                  <% } %>
                </select>
                <select class="form-select" id="expiryYear">
                  <% const currentYear = new Date().getFullYear(); %>
                  <% for(let i = 0; i <= 10; i++) { %>
                  <option value="<%= currentYear + i %>"><%= currentYear + i %></option>
                  <% } %>
                </select>
              </div>
            </div>
            <div class="col-6">
              <label class="form-label">CVV</label>
              <input type="text" class="form-control" id="cardCvv" placeholder="123" maxlength="4">
            </div>
          </div>
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="setAsDefault" checked>
            <label class="form-check-label" for="setAsDefault">Set as default payment method</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="addPaymentMethod()">Add Card</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const token = '<%= token %>';
    const basePath = window.APP_BASE_PATH || '';
    let currentEditField = '';
    let editModal, addPaymentModal;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize tooltips
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      editModal = new bootstrap.Modal(document.getElementById('editModal'));
      addPaymentModal = new bootstrap.Modal(document.getElementById('addPaymentModal'));

      // Load data
      loadAccountData();

      // Notification toggle handlers
      document.querySelectorAll('.notification-toggle').forEach(toggle => {
        toggle.addEventListener('change', updateNotifications);
      });

      // Card number formatting
      document.getElementById('cardNumber')?.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(.{4})/g, '$1 ').trim();
        e.target.value = value;
      });
    });

    async function loadAccountData() {
      try {
        const res = await fetch(`${basePath}/admin/api/account?token=${token}`);
        const data = await res.json();
        if (data.success) {
          // Update display
          if (data.profile) {
            document.getElementById('displayName').textContent = data.profile.name || 'Not set';
            document.getElementById('displayEmail').textContent = data.profile.email || 'Not set';
            document.getElementById('displayPhone').textContent = data.profile.phone || 'Not set';
          }
          // Update payment methods
          renderPaymentMethods(data.paymentMethods || []);
          // Update notifications
          if (data.notificationPrefs) {
            Object.keys(data.notificationPrefs).forEach(key => {
              const toggle = document.getElementById(key);
              if (toggle) toggle.checked = data.notificationPrefs[key];
            });
          }
          // Update devices
          renderDevices(data.devices || []);
        }
      } catch (err) {
        console.error('Error loading account data:', err);
      }
    }

    function renderPaymentMethods(methods) {
      const container = document.getElementById('paymentMethodsList');
      if (methods.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-4">No payment methods saved yet.</p>';
        return;
      }
      container.innerHTML = methods.map(m => `
        <div class="payment-card ${m.isDefault ? 'default' : ''}">
          <div class="card-info">
            <i class="bi bi-credit-card-2-front card-icon text-${getCardColor(m.cardType)}"></i>
            <div>
              <div class="fw-bold">${m.cardType} ending in ${m.cardLast4}</div>
              <small class="text-muted">Expires ${String(m.expiryMonth).padStart(2, '0')}/${m.expiryYear}</small>
              ${m.isDefault ? '<span class="badge bg-primary ms-2">Default</span>' : ''}
            </div>
          </div>
          <div>
            ${!m.isDefault ? `<button class="btn btn-sm btn-outline-primary me-2" onclick="setDefaultPayment('${m.id}')" data-bs-toggle="tooltip" title="Set as default"><i class="bi bi-star"></i></button>` : ''}
            <button class="btn btn-sm btn-outline-danger" onclick="removePaymentMethod('${m.id}')" data-bs-toggle="tooltip" title="Remove this payment method"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      `).join('');
    }

    function getCardColor(type) {
      const colors = { 'Visa': 'primary', 'Mastercard': 'danger', 'Amex': 'info', 'Discover': 'warning' };
      return colors[type] || 'secondary';
    }

    function renderDevices(devices) {
      const container = document.getElementById('devicesList');
      if (devices.length === 0) {
        container.innerHTML = `
          <div class="device-item current">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-3">
                <i class="bi bi-laptop fs-3 text-primary"></i>
                <div>
                  <div class="fw-bold">Current Device</div>
                  <small class="text-muted">This browser session</small>
                </div>
              </div>
              <span class="badge bg-success">Active Now</span>
            </div>
          </div>`;
        return;
      }
      container.innerHTML = devices.map(d => `
        <div class="device-item ${d.isCurrent ? 'current' : ''}">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
              <i class="bi bi-${getDeviceIcon(d.deviceType)} fs-3 ${d.isCurrent ? 'text-primary' : 'text-secondary'}"></i>
              <div>
                <div class="fw-bold">${d.deviceName || 'Unknown Device'}</div>
                <small class="text-muted">${d.browser || ''} ${d.osName ? '- ' + d.osName : ''}</small>
                <br><small class="text-muted">Last active: ${new Date(d.lastSeenAt).toLocaleString()}</small>
              </div>
            </div>
            <div>
              ${d.isCurrent
                ? '<span class="badge bg-success">Active Now</span>'
                : `<button class="btn btn-sm btn-outline-danger" onclick="signOutDevice('${d.id}')" data-bs-toggle="tooltip" title="Sign out this device"><i class="bi bi-box-arrow-right"></i></button>`}
            </div>
          </div>
        </div>
      `).join('');
    }

    function getDeviceIcon(type) {
      const icons = { 'desktop': 'laptop', 'mobile': 'phone', 'tablet': 'tablet' };
      return icons[type] || 'device-hdd';
    }

    function showEditModal(field) {
      currentEditField = field;
      const modal = document.getElementById('editModal');
      const title = document.getElementById('editModalTitle');
      const body = document.getElementById('editModalBody');

      const templates = {
        name: { title: 'Edit Name', body: `<div class="mb-3"><label class="form-label">Name</label><input type="text" class="form-control" id="editValue" value="${document.getElementById('displayName').textContent}"></div>` },
        email: { title: 'Change Email', body: `<div class="mb-3"><label class="form-label">New Email</label><input type="email" class="form-control" id="editValue" value="${document.getElementById('displayEmail').textContent}"></div><div class="mb-3"><label class="form-label">Current Password</label><input type="password" class="form-control" id="editPassword" placeholder="Enter current password to confirm"></div>` },
        phone: { title: 'Edit Phone', body: `<div class="mb-3"><label class="form-label">Phone Number</label><input type="tel" class="form-control" id="editValue" value="${document.getElementById('displayPhone').textContent !== 'Not set' ? document.getElementById('displayPhone').textContent : ''}"></div>` },
        password: { title: 'Change Password', body: `<div class="mb-3"><label class="form-label">Current Password</label><input type="password" class="form-control" id="currentPassword"></div><div class="mb-3"><label class="form-label">New Password</label><input type="password" class="form-control" id="newPassword"></div><div class="mb-3"><label class="form-label">Confirm New Password</label><input type="password" class="form-control" id="confirmPassword"></div>` }
      };

      const config = templates[field];
      title.textContent = config.title;
      body.innerHTML = config.body;
      editModal.show();
    }

    async function saveEdit() {
      let endpoint = `${basePath}/admin/api/account/${currentEditField}`;
      let body = {};

      if (currentEditField === 'name') {
        body = { name: document.getElementById('editValue').value };
      } else if (currentEditField === 'email') {
        body = { email: document.getElementById('editValue').value, password: document.getElementById('editPassword').value };
      } else if (currentEditField === 'phone') {
        body = { phone: document.getElementById('editValue').value };
      } else if (currentEditField === 'password') {
        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmPassword').value;
        if (newPass !== confirmPass) {
          alert('Passwords do not match');
          return;
        }
        body = { currentPassword: document.getElementById('currentPassword').value, newPassword: newPass };
      }

      try {
        const res = await fetch(`${endpoint}?token=${token}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
          editModal.hide();
          loadAccountData();
        } else {
          alert('Error: ' + (data.error || 'Failed to save'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function showAddPaymentModal() {
      document.getElementById('cardNumber').value = '';
      document.getElementById('cardHolderName').value = '';
      document.getElementById('cardCvv').value = '';
      document.getElementById('setAsDefault').checked = true;
      addPaymentModal.show();
    }

    async function addPaymentMethod() {
      const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const cardHolderName = document.getElementById('cardHolderName').value;
      const expiryMonth = document.getElementById('expiryMonth').value;
      const expiryYear = document.getElementById('expiryYear').value;
      const isDefault = document.getElementById('setAsDefault').checked;

      // Determine card type
      let cardType = 'Card';
      if (cardNumber.startsWith('4')) cardType = 'Visa';
      else if (/^5[1-5]/.test(cardNumber)) cardType = 'Mastercard';
      else if (/^3[47]/.test(cardNumber)) cardType = 'Amex';
      else if (/^6(?:011|5)/.test(cardNumber)) cardType = 'Discover';

      try {
        const res = await fetch(`${basePath}/admin/api/account/payment-methods?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cardType,
            cardLast4: cardNumber.slice(-4),
            cardHolderName,
            expiryMonth: parseInt(expiryMonth),
            expiryYear: parseInt(expiryYear),
            isDefault
          })
        });
        const data = await res.json();
        if (data.success) {
          addPaymentModal.hide();
          loadAccountData();
        } else {
          alert('Error: ' + (data.error || 'Failed to add payment method'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function setDefaultPayment(id) {
      try {
        const res = await fetch(`${basePath}/admin/api/account/payment-methods/${id}/default?token=${token}`, { method: 'PUT' });
        const data = await res.json();
        if (data.success) loadAccountData();
        else alert('Error: ' + (data.error || 'Failed to set default'));
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removePaymentMethod(id) {
      if (!confirm('Remove this payment method?')) return;
      try {
        const res = await fetch(`${basePath}/admin/api/account/payment-methods/${id}?token=${token}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) loadAccountData();
        else alert('Error: ' + (data.error || 'Failed to remove'));
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function updateNotifications() {
      const prefs = {};
      document.querySelectorAll('.notification-toggle').forEach(toggle => {
        prefs[toggle.dataset.key] = toggle.checked;
      });
      try {
        await fetch(`${basePath}/admin/api/account/notifications?token=${token}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(prefs)
        });
      } catch (err) {
        console.error('Error updating notifications:', err);
      }
    }

    async function signOutDevice(id) {
      if (!confirm('Sign out this device?')) return;
      try {
        const res = await fetch(`${basePath}/admin/api/account/devices/${id}?token=${token}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) loadAccountData();
        else alert('Error: ' + (data.error || 'Failed to sign out device'));
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function signOutAllDevices() {
      if (!confirm('Sign out of all other devices?')) return;
      try {
        const res = await fetch(`${basePath}/admin/api/account/devices?token=${token}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          alert('Signed out of all other devices');
          loadAccountData();
        } else {
          alert('Error: ' + (data.error || 'Failed to sign out devices'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
  </script>
</body>
</html>
